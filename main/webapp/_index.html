<!DOCTYPE html>
<html>
<head>
	<title>Icon Pixel Operations</title>
	<link rel="stylesheet" href="https://openlayers.org/en/v3.20.1/css/ol.css" type="text/css">
	<!-- The line below is only needed for old environments like Internet Explorer and Android 4.x -->
	<script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=requestAnimationFrame,Element.prototype.classList,URL"></script>
	<script src="https://openlayers.org/en/v3.20.1/build/ol.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script> <!-- still used in the menu dropdowns -->


	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">

</head>
<body>

	<style type="text/css">
		html, body, #basicMap {
			width: 100%;
			height: 100%;
			margin: 0;
		}
	</style>


	<div id="map" class="map"><div id="popup"></div></div>
	<script>


		/*
		
		Notes:
		Windspeed is metres/second - Wind direction is in degrees
		Temperatures are always Celcius
		Current speeds are always Knots - Current direction is in degrees
		Legspeeds are in knots


		CODE SECTION OVERVIEW:
		Manipulation handles
			math
		
		Definitions
			mock RTZ object
			Weather On Route Marker (WORM) generator

		Content building 
			Route and Points
			Weather On Route Marker (WORM)

		Map init

		User interaction
			mousemove
			mouseover
			mouseclick


		TODO:
		Determine a number of WOR Markers (WORM) to place (2/3) of route markers, maximum & minimum
		Choose which routemarkers will be used for WORMs so they are not too close to each other
		Place positions of chosen legs into object as pairs
		Simulate weather conditions for markers (Windspeed, winddirection, currentspeed, currentdirection, wavedirection, waveheight.) (No water depth yet.)
		Place generate marker and push into object
		Make thick invisible line over route, when clicked, displays WORM for that location, in the RTZ ETA timeframe.
		when user clicks anywhere on map outside of route, generate a WORM and populate with data.


		QUESTION AND MISSING
		1: Does a click on land - request for weather data from DMI, display water depth = 0 or what?


		*/






		//MANIPULATION HANDLES -----------------------------------------------------------------------------
		// convert degrees to radians
		function degToRad(deg) {
			return deg * Math.PI * 2 / 360;
		}

		// convert radians to degrees
		function radToDeg(rad) {
			return rad * 360 / (Math.PI * 2);
		}
		//END MANIPULATION HANDLES -----------------------------------------------------------------------------




		//DEFINITIONS ------------------------------------------------------------------------------------------
		var route = {
			waypoints: [
			{ id: 0, name: "pos1", legspeedmin: 12, legspeedmax: 13, lon: 13.711061468866212, lat: 55.07291720021519, winddirection: 120, windspeed: 24, airtemperature: 9, currentdirection: 155, currentspeed: 3.2 },
			{ id: 1, name: "pos2", legspeedmin: 11, legspeedmax: 12, lon: 12.663240423944345, lat: 54.880610640482985, winddirection: 120, windspeed: 28, airtemperature: 9, currentdirection: 140, currentspeed: 3.1 },
			{ id: 2, name: "pos3", legspeedmin: 11, legspeedmax: 12, lon: 12.005518697218807, lat: 54.53590450023398, winddirection: 120, windspeed: 30, airtemperature: 9, currentdirection: 136, currentspeed: 3.4 },
			{ id: 3, name: "pos4", legspeedmin: 10, legspeedmax: 11, lon: 11.93099777456585, lat: 54.569907839824936, winddirection: 120, windspeed: 30, airtemperature: 9, currentdirection: 130, currentspeed: 3.8 }
			]
		}
		//END DEFINITIONS ------------------------------------------------------------------------------------------




		//CONTENT BUILDING -----------------------------------------------------------------------------------------

		//Routelines only, returned on its own layer.
		var createRoute = function () { //assumes no error in route object
			function createcoords() {
				var ret = [];
				for (var i = 0; i != route.waypoints.length; i++) {
					var tmparr = [];
					tmparr.push(route.waypoints[i].lon);
					tmparr.push(route.waypoints[i].lat);
					ret.push(tmparr);
				}
				return ret
			}
			var coords = createcoords();
			var lineString = new ol.geom.LineString(coords);
			lineString.transform('EPSG:4326', 'EPSG:3857'); 
			var feature = new ol.Feature({ // create the feature
				geometry: lineString,
				//name: 'Route Leg',
			});
			var lineStyle = new ol.style.Style({
				stroke: new ol.style.Stroke({
					color: 'rgba(255,0,0,0.5)',
					width: 5
				})
			});
			var source = new ol.source.Vector({
				features: [feature]
			});
			var vectorLayer = new ol.layer.Vector({
				source: source,
				style: [lineStyle],
				name: 'routelineslayer'
			});
			return vectorLayer;
		}




		//Route start & end points - names: RouteStartDot, RouteEndDot
		RSEstyle = function () { //route start end style - scales according to zoom level in USER INTERACTION section
			return [new ol.style.Style({
				stroke: new ol.style.Stroke({
					color: 'rgba(200,0,0,1)',
					width: 10
				})
			})];
		};
		var createRouteDots = function () {
			var feature1 = new ol.Feature({ // create the feature
				geometry: new ol.geom.Circle([route.waypoints[0].lon, route.waypoints[0].lat]).transform('EPSG:4326', 'EPSG:3857'),
				name: 'RouteStartDot',
				lon: route.waypoints[0].lon,
				lat: route.waypoints[0].lat
			});
			var feature2 = new ol.Feature({ // create the feature
				geometry: new ol.geom.Circle([route.waypoints[route.waypoints.length - 1].lon, route.waypoints[route.waypoints.length - 1].lat]).transform('EPSG:4326', 'EPSG:3857'),
				name: 'RouteEndDot',
				lon: route.waypoints[route.waypoints.length - 1].lon,
				lat: route.waypoints[route.waypoints.length - 1].lat
			});
			feature1.setId('RouteStartDot');
			feature2.setId('RouteEndDot');
			feature1.setStyle(RSEstyle());
			feature2.setStyle(RSEstyle());
			return [feature1, feature2];
		}








		//Weather On Route Marker (WORM) generator
		WORMstyle = function (zoomlvl, src) { //route start end style - scales according to zoom level in USER INTERACTION section
		console.log("src:",src)
			return [new ol.style.Style({
				image: new ol.style.Icon(({
					opacity: 0.75,
					//rotation: degToRad(-135), //wavepointer is pointing lowerright
					//anchor: [0.5, 0.5],
					//anchorXUnits: 'fraction',
					//anchorYUnits: 'fraction',
					src: src,
					scale: 0.5 //- (zoomlvl/10)
				}))
			})];
		};
		var WORMarker; //When user clicks anywhere on map
		var WORMarkers = []; //array for multiple markers along route
		var generateWORM = function (identifier) { //identifier is given so it can be styled
			var iconFeature = new ol.Feature({ //WAVEARROW
				geometry: new ol.geom.Point([13, 54]).transform('EPSG:4326', 'EPSG:3857'),
				name: 'WOR_backdropcircle',
				type: identifier,
				src: 'WOR_backdropcircle.png',
			});
			var iconStyle = new ol.style.Style({
				image: new ol.style.Icon(({
					opacity: 0.75,
					rotation: degToRad(-135), //wavepointer is pointing lowerright
					anchor: [0.5, 0.5],
					anchorXUnits: 'fraction',
					anchorYUnits: 'fraction',
					src: 'WOR_backdropcircle.png', //needs path
					scale:0.5
				}))
			});
			iconFeature.setStyle(iconStyle);
			iconFeature.setId('WOR_backdropcircle');

			//CURRENTARROW
			var iconFeature2 = new ol.Feature({
				geometry: new ol.geom.Point([13, 54]).transform('EPSG:4326', 'EPSG:3857'),
				name: 'WOR_innercircle',
				type: identifier,
				src: 'WOR_innercircle.png',
			});
			var iconStyle = new ol.style.Style({
				image: new ol.style.Icon(({
					opacity: 1,
					rotation: degToRad(-135), //currentpointer is pointing lowerright
					anchor: [0.5, 0.5],
					anchorXUnits: 'fraction',
					anchorYUnits: 'fraction',
					src: 'WOR_innercircle.png', //needs path
					scale:0.5
				}))
			});
			iconFeature2.setStyle(iconStyle);
			iconFeature2.setId('WOR_innercircle');

			//WINDARROW
			var iconFeature3 = new ol.Feature({
				geometry: new ol.geom.Point([13, 54]).transform('EPSG:4326', 'EPSG:3857'),
				name: 'WOR_windmarker',
				type: identifier,
				src: 'img/wind/mark005.png',
			});
			var iconStyle = new ol.style.Style({
				image: new ol.style.Icon(({
					opacity: 1,
					rotation: degToRad(180), //windpointer is straight is pointing straight down
					anchor: [0.52, 0.25],
					anchorXUnits: 'fraction',
					anchorYUnits: 'fraction',
					src: 'img/wind/mark005.png', //needs path
					scale:0.7
				}))
			});
			iconFeature3.setStyle(iconStyle);
			iconFeature3.setId('WOR_windmarker');


			return [iconFeature, iconFeature2, iconFeature3];
		}
		WORMarker = generateWORM('_usermarker');



			//END WEATHER ON ROUTE MARKER (WORM) *****************************************************





			var generateRouteLayer = function () {
				var point = new ol.geom.Point([0, 0]).transform('EPSG:4326', 'EPSG:3857'); //transform to EPSG:3857
				var feature = new ol.Feature({ // create the feature
					geometry: point,
				});
				var pointStyle = new ol.style.Style({
					stroke: new ol.style.Stroke({
						color: 'rgba(255,0,0,0)',
						width: 100
					})
				});
				var source = new ol.source.Vector({
					features: [feature]
				});
				var routeLayer = new ol.layer.Vector({
					source: source,
					style: [pointStyle],
					name: 'routeLayer'
				});
				return routeLayer;
			}


			// MAP INIT
			//**************************************************************
			//**************************************************************

			var routeLayer = generateRouteLayer();

			var routeHandle = createRoute();
			var routeDotsHandle = createRouteDots();

			var map = new ol.Map({
				loadTilesWhileInteracting: true,
				target: 'map',
				layers: [
				new ol.layer.Tile({
					source: new ol.source.OSM()
				}), routeHandle, routeLayer
				],
				view: new ol.View({
					center: ol.proj.transform([12.68383978917871, 54.83159902246746], 'EPSG:4326', 'EPSG:3857'),
					zoom: 9
				})
			});

			var source = routeLayer.getSource();
			source.addFeatures(routeDotsHandle);
			source.addFeatures(WORMarker);



			//**************************************************************
			//**************************************************************
			//MAP INIT END








			//**************************************************************
			// USER INTERACTION - MOUSE & TOUCH

			map.on('pointermove', function (evt) {
				var feature = map.forEachFeatureAtPixel(evt.pixel,
				function (feature) {
					return feature;
				});
				var indexOfFeatures = "RouteStartDot, RouteEndDot"
				if (feature) {
					if (indexOfFeatures.indexOf(feature.get('name')) > -1) {
						map.getTargetElement().style.cursor = map.hasFeatureAtPixel(evt.pixel) ? 'pointer' : '';
					}
				} else {
					map.getTargetElement().style.cursor = map.hasFeatureAtPixel(evt.pixel) ? 'pointer' : '';
				}

			});



			map.on('click', function (evt) {
				var lonlat = ol.proj.transform(evt.coordinate, 'EPSG:3857', 'EPSG:4326');
				var lon = lonlat[0];
				var lat = lonlat[1];

				console.log("Mouse lon:" + lon + " - " + "lat:" + lat);

				var feature = map.forEachFeatureAtPixel(evt.pixel, function (feature) {
					return feature;
				});

				if (feature) { //a feature can have more info so is generated differently for now
					console.log("Clicked on: " + feature.get('name') + " - Coords:" + feature.get('lon') + "," + feature.get('lat'));
				} else {
					console.log("Clicked on nothing.");
				}


				//Place a WORM (feature 'type' == '_usermarker') by moving the existing one at pos 0,0 scaled to 0 or where user last clicked it
				if (!feature) {
					//feature.getStyle().getImage().setRotation(135 * 0.01745329251);
					//feature.get("name")
					console.log("Going to move WORM to:", lonlat)
				}
				//	feature.getStyle().getImage().setRotation(135 * 0.01745329251);





			});

			//ZOOM DETECT - rescale items as needed
			map.on("moveend", function (e) {
				var zoomlvl = parseInt(map.getView().getZoom());
				console.log("Zoom level:" + zoomlvl);

				//loop through all layers to rescale route items so they dont fill the entire area
				map.getLayers().forEach(function (layer, i) {
					if (layer instanceof ol.layer.Vector) {
						var prop = layer.getProperties();
						var src = layer.getSource();
						if (src) {
							src.forEachFeature(function (feature) { //loop through each feature
								var name = feature.get("name");
								var type = feature.get("type");
								var src = feature.get("src");
								//console.log("name:", name);
								var styleRouteStartEnd = new ol.style.Style({
									stroke: new ol.style.Stroke({
										color: 'rgba(200,0,0,1)',
										width: zoomlvl * 2
									}),
									fill: new ol.style.Fill({
										color: 'rgba(255, 0, 255, 0.1)'
									})
								});
								//Manipulate features as needed
								if (name && name != '') {
									if (name == "RouteStartDot") feature.setStyle(RSEstyle());
									if (name == "RouteEndDot") feature.setStyle(RSEstyle());
								}
								if (type && type != '') {
									
									if (type == '_usermarker') {
										if (zoomlvl > 5) {
											feature.getStyle().getImage().setScale(.5 * (zoomlvl / 10));
										} else {
											feature.getStyle().getImage().setScale(0.00001);
										}
									}
								}
							})
						}
					}
				});

			})



			// END USER INTERACTION - MOUSE & TOUCH
			//**************************************************************

	</script>
</body>
</html>